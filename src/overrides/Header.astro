---
/**
 * Custom header override â€” adds a navigation dropdown menu (hamburger icon)
 * next to the GitHub social icon for quick section access on all viewports.
 *
 * Based on Starlight's Header.astro with an additional nav-menu component.
 */
import config from 'virtual:starlight/user-config';

import LanguageSelect from 'virtual:starlight/components/LanguageSelect';
import Search from 'virtual:starlight/components/Search';
import SiteTitle from 'virtual:starlight/components/SiteTitle';
import SocialIcons from 'virtual:starlight/components/SocialIcons';
import ThemeSelect from 'virtual:starlight/components/ThemeSelect';

const shouldRenderSearch =
  config.pagefind || config.components.Search !== '@astrojs/starlight/components/Search.astro';

const navSections = [
  { label: 'Overview', href: '/attest-website/overview/' },
  { label: 'Python SDK', href: '/attest-website/getting-started/python/' },
  { label: 'TypeScript SDK', href: '/attest-website/getting-started/typescript/' },
  { label: 'Guides', href: '/attest-website/guides/framework-adapters/' },
  { label: 'Architecture', href: '/attest-website/architecture/overview/' },
  { label: 'Reference', href: '/attest-website/reference/python/expect-dsl/' },
  { label: 'Migration', href: '/attest-website/migration/from-deepeval/' },
  { label: 'Changelog', href: '/attest-website/changelog/' },
];
---

<div class="header">
  <div class="title-wrapper sl-flex">
    <SiteTitle />
  </div>
  <div class="sl-flex print:hidden">
    {shouldRenderSearch && <Search />}
  </div>
  <div class="sl-hidden md:sl-flex print:hidden right-group">
    <div class="sl-flex social-icons">
      <SocialIcons />
    </div>
    <ThemeSelect />
    <LanguageSelect />
    <attest-nav-menu>
      <button
        class="nav-menu-toggle"
        aria-label="Navigation menu"
        aria-expanded="false"
        aria-controls="attest-nav-dropdown"
      >
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
          <path d="M3 5h14M3 10h14M3 15h14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
      </button>
      <nav id="attest-nav-dropdown" class="nav-dropdown" hidden>
        <ul>
          {navSections.map(({ label, href }) => (
            <li><a href={href}>{label}</a></li>
          ))}
        </ul>
      </nav>
    </attest-nav-menu>
  </div>
</div>

<script>
  class AttestNavMenu extends HTMLElement {
    constructor() {
      super();
      const btn = this.querySelector<HTMLButtonElement>('.nav-menu-toggle')!;
      const dropdown = this.querySelector<HTMLElement>('.nav-dropdown')!;

      const toggle = (open?: boolean) => {
        const isOpen = open ?? dropdown.hidden;
        dropdown.hidden = !isOpen;
        btn.setAttribute('aria-expanded', String(isOpen));
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggle();
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!this.contains(e.target as Node)) {
          toggle(false);
        }
      });

      // Close on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !dropdown.hidden) {
          toggle(false);
          btn.focus();
        }
      });

      // Close when navigating
      dropdown.addEventListener('click', (e) => {
        if ((e.target as HTMLElement).closest('a')) {
          toggle(false);
        }
      });
    }
  }
  customElements.define('attest-nav-menu', AttestNavMenu);
</script>

<style>
  .header {
    display: flex;
    gap: var(--sl-nav-gap);
    justify-content: space-between;
    align-items: center;
    height: 100%;
  }

  .title-wrapper {
    overflow: clip;
    padding: 0.25rem;
    margin: -0.25rem;
    min-width: 0;
  }

  .right-group,
  .social-icons {
    gap: 1rem;
    align-items: center;
  }
  .social-icons::after {
    content: '';
    height: 2rem;
    border-inline-end: 1px solid var(--sl-color-gray-5);
  }

  @media (min-width: 50rem) {
    :global(:root[data-has-sidebar]) {
      --__sidebar-pad: calc(2 * var(--sl-nav-pad-x));
    }
    :global(:root:not([data-has-toc])) {
      --__toc-width: 0rem;
    }
    .header {
      --__sidebar-width: max(0rem, var(--sl-content-inline-start, 0rem) - var(--sl-nav-pad-x));
      --__main-column-fr: calc(
        (
            100% + var(--__sidebar-pad, 0rem) - var(--__toc-width, var(--sl-sidebar-width)) -
              (2 * var(--__toc-width, var(--sl-nav-pad-x))) - var(--sl-content-inline-start, 0rem) -
              var(--sl-content-width)
          ) / 2
      );
      display: grid;
      grid-template-columns:
        minmax(
          calc(var(--__sidebar-width) + max(0rem, var(--__main-column-fr) - var(--sl-nav-gap))),
          auto
        )
        1fr
        auto;
      align-content: center;
    }
  }

  /* Nav menu toggle button */
  attest-nav-menu {
    position: relative;
    display: flex;
    align-items: center;
  }

  .nav-menu-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    padding: 0;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    color: var(--sl-color-gray-5);
    cursor: pointer;
    transition: color 0.15s ease, background-color 0.15s ease;
  }

  .nav-menu-toggle:hover,
  .nav-menu-toggle[aria-expanded="true"] {
    color: var(--sl-color-accent);
    background-color: var(--sl-color-gray-2);
  }

  /* Dropdown */
  .nav-dropdown {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    z-index: 10;
    min-width: 12rem;
    padding: 0.5rem 0;
    border: 1px solid var(--attest-border-medium);
    border-radius: 0.5rem;
    background: var(--sl-color-gray-1);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .nav-dropdown ul {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .nav-dropdown li a {
    display: block;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: var(--sl-color-gray-6);
    text-decoration: none;
    transition: background-color 0.1s ease, color 0.1s ease;
  }

  .nav-dropdown li a:hover {
    background-color: var(--sl-color-gray-2);
    color: var(--sl-color-accent);
  }
</style>
